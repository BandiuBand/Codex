# CONCEPT_LOCK.md — Непорушна концепція Codex (відступи заборонені)

Цей документ — **єдине джерело правди** для архітектури та UI.  
Будь-які зміни/рефакторинг/фічі **НЕ МОЖУТЬ** суперечити правилам нижче.  
Якщо щось “не вміщується” — значить реалізація неправильна, а не концепція.

---

## 1) Є тільки одна сутність: Agent

**Agent** — єдина структурна одиниця системи.  
Немає і не буде окремих сутностей “tool”, “node”, “step”, “workflow”, “pipeline”.

- **Atomic Agent**: виконується як одна дія (LLM / Python / Shell).
- **Composite Agent**: складається з інших Agent та їх зв’язків.

**Workflow = Composite Agent.**  
**Tool = Atomic Agent.**  
**Node = Agent.**  
Ці слова НЕ використовуються в коді/моделі/інтерфейсі.

---

## 2) Єдине представлення для всього: змінні + зв’язки + lanes

Будь-яка логіка описується тільки цими елементами:

### 2.1 Змінні агента
- **Inputs** — вхідні змінні (ліва сторона)
- **Locals** — внутрішні змінні (верхня сторона)
- **Outputs** — вихідні змінні (права сторона)

Жодних “налаштувань”, “конфігів”, “форм промпта”, “параметрів команди” як окремих панелей не існує.  
Усе задається через змінні.

### 2.2 Default-значення
Default-значення НЕ є “полем конфігурації”.
Default реалізується так:
- **Input змінна отримує значення через зв’язок від Local змінної.**
Тобто “дефолт” = підключений Local.

### 2.3 Зв’язки
Є тільки зв’язок **змінна → змінна** (drag&drop з іконки на іконку).

- Жодних форм “вкажи mapping вручну” як основного способу.
- Ручне редагування допускається тільки як доп. режим для дебагу, але UI за замовчуванням — лише перетягування.

### 2.4 Lanes (вертикальні колонки)
Канва поділена на вертикальні смуги (lanes/columns), які виконуються зліва направо.

- Усередині однієї lane агенти **можуть виконуватись паралельно** (barrier семантика).
- Наступна lane стартує тільки після завершення всіх агентів цієї lane, які **дійсно запускались**.
- Агенти, які пропущені умовою (гілка не активна), **не блокують** lane.

---

## 3) Розгалуження і цикли — тільки через Agent

### 3.1 Розгалуження
Розгалуження робиться умовним запуском агентів (у composite агенті).

- Умова може бути:
  - просто булева змінна
  - результат іншого агента (включно з LLM-агентом)
  - результат python-агента, який обчислив умову

Немає окремих “if/else nodes”. Є тільки агенти й умови їх запуску.

### 3.2 Цикли
Цикл реалізується через:
- лічильник (python-агент) → змінна
- умова запуску → повторний виклик самого composite агента (self-call)

Обов’язкові запобіжники в engine:
- `max_steps`
- `max_depth`

---

## 4) UI — строго визначений і НЕ розширюється “панелями”

UI повинен бути **строго** таким:

### 4.1 Top bar (обов’язкові кнопки)
- **Новий**
- **Завантажити** (dropdown зі списком агентів)
- **Зберегти**
- **Створити нового**
- **Додати агента на канву** (dropdown зі списком агентів)

Жодних додаткових панелей “налаштувань тулів”, “списку кроків”, “умов тулів”.

### 4.2 Представлення змінних
Змінні — **невеликі прямокутники**:

- **Input / Output**: 1 поле (назва)
- **Local**: 2 поля (назва + значення)

### 4.3 Представлення агента на канві
На прямокутнику агента:
- зліва: **іконки inputs** з назвами
- зверху: **іконки locals** з назвами
- справа: **іконки outputs** з назвами

**Саме ці іконки — єдина точка взаємодії для з’єднань.**

### 4.4 З’єднання змінних
З’єднання робиться лише перетягуванням:
- тягнеш з іконки змінної-джерела → на іконку змінної-приймача
- візуально з’являється лінія
- зв’язок можна видалити (клік по лінії + delete або кнопка “видалити”)

### 4.5 Мова
Інтерфейс **українською без винятків**.

---

## 5) Виконання агентів — без “магії”, контрольоване й серіалізується

### 5.1 Виконання atomic агентів
Atomic агент виконує одну дію і повертає outputs.
Дія може бути:
- LLM (з можливістю витягнути JSON)
- Python
- Shell

У UI це не “режим”, не “тип вузла”, не “тул”. Це просто агент.

### 5.2 Серіалізація
Кожен запуск агента створює `run_id` і зберігає:
- state vars
- trace подій виконання
- помилки

### 5.3 LLM = Agent, жодних центральних конфігів
- Будь-який LLM викликається ТІЛЬКИ як atomic Agent (наприклад, `llm_ollama`).
- Усі параметри LLM (host/model/temperature/... ) задаються виключно змінними цього агента.
- Engine/Web не мають “магічних” LLM-конфігів або глобальних налаштувань. Дозволено лише те, що явно прописано в AgentSpec (inputs/locals).

---

## 6) Заборонені відхилення (жорсткий список)
Заборонено:
- вводити окремі типи “node/tool/workflow”
- робити “конфіг панелі” для промптів/коду/команд як окрему концепцію
- вимагати ручні таблиці mapping замість drag&drop
- ховати змінні не в тих місцях (inputs зліва, locals зверху, outputs справа)
- робити UI англійською або змішаною
- додавати “допоміжні панелі”, яких не було в описі, як частину основного UX

---

## 7) Критерій приймання (Acceptance)
Будь-який PR/коміт вважається прийнятним тільки якщо:
1) UI відповідає пунктам 4.1–4.5 без додаткових “вигаданих” секцій.
2) Є drag&drop з’єднання змінних між іконками.
3) Можна створити composite агента з 2 lanes і 2 гілками через умови.
4) Є запуск агента і отримання outputs.
5) Після запуску є серіалізація state+trace.

---

## 8) Як вносити зміни в концепцію (єдиний дозволений спосіб)
Змінювати концепцію можна тільки так:
1) Запропонувати зміну у вигляді PR до `CONCEPT_LOCK.md`
2) Отримати письмове “ОК” від власника концепції (BandiuBand)
3) Лише після цього змінювати код/UI

Якщо PR суперечить цьому документу — він відхиляється незалежно від “зручності” чи “особистих уподобань” розробника.
