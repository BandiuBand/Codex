name: complex_task_handler
title_ua: Обробка складного завдання
description_ua: Перевірка даних, планування, виконання кроків і підсумок
kind: composite
inputs:
- name: завдання
- name: max_reviews
- name: stop_agent_execution
  type: bool
  default: false
locals:
- name: ollama_host
  value: http://127.0.0.1:11434
- name: model
  value: qwen3:32b
- name: temperature
  value: 0.2
- name: summary_require_schema
  value: true
outputs:
- name: уточнення
- name: план
- name: кроки
- name: критерії
- name: виконані_кроки
- name: пройшло_перевірку
- name: коментар_цербера
- name: потрібно_повторити
- name: результат_виконання
- name: фінальна_відповідь
- name: next_stage_hint
- name: потрібні_уточнення
- name: аналіз_даних
- name: план_json
- name: план_як_рядок
- name: план_json_error
- name: план_ok
- name: уточнюючі_питання
- name: попередній_контекст
- name: зведення
- name: резюме
- name: summary_flags
- name: summary_needs_more_info
- name: summary_json_error
- name: ok
- name: needs_more_info
- name: clarifications
- name: context_summary
- name: user_answer
- name: json_error
graph:
  lanes:
  - items:
    - id: review
      agent: data_review
      bindings:
      - from_agent_item_id: __CTX__
        from_var: завдання
        to_agent_item_id: review
        to_var: завдання
      - from_agent_item_id: __CTX__
        from_var: ollama_host
        to_agent_item_id: review
        to_var: ollama_host
      - from_agent_item_id: __CTX__
        from_var: model
        to_agent_item_id: review
        to_var: model
      - from_agent_item_id: __CTX__
        from_var: temperature
        to_agent_item_id: review
        to_var: temperature
      ui:
        lane_index: 0
        order: 0
  - items:
    - id: clarify
      agent: chat_agent
      bindings:
      - from_agent_item_id: __CTX__
        from_var: уточнюючі_питання
        to_agent_item_id: clarify
        to_var: message_to_user
      - from_agent_item_id: __CTX__
        from_var: потрібні_уточнення
        to_agent_item_id: clarify
        to_var: needs_response
      when:
        var: потрібні_уточнення
        equals: true
      ui:
        lane_index: 1
        order: 0
  - items:
    - id: merge_context
      agent: clarification_context
      bindings:
      - from_agent_item_id: __CTX__
        from_var: попередній_контекст
        to_agent_item_id: merge_context
        to_var: базовий_контекст
      - from_agent_item_id: __CTX__
        from_var: відповідь_користувача
        to_agent_item_id: merge_context
        to_var: відповідь_користувача
      ui:
        lane_index: 2
        order: 0
  - items:
    - id: planner
      agent: llm_plan_builder
      bindings:
      - from_agent_item_id: __CTX__
        from_var: завдання
        to_agent_item_id: planner
        to_var: завдання
      - from_agent_item_id: __CTX__
        from_var: попередній_контекст
        to_agent_item_id: planner
        to_var: попередній_контекст
      - from_agent_item_id: __CTX__
        from_var: ollama_host
        to_agent_item_id: planner
        to_var: ollama_host
      - from_agent_item_id: __CTX__
        from_var: model
        to_agent_item_id: planner
        to_var: model
      - from_agent_item_id: __CTX__
        from_var: temperature
        to_agent_item_id: planner
        to_var: temperature
      ui:
        lane_index: 3
        order: 0
  - items:
    - id: normalize
      agent: plan_normalizer
      bindings:
      - from_agent_item_id: __CTX__
        from_var: план_json
        to_agent_item_id: normalize
        to_var: план_json
      ui:
        lane_index: 4
        order: 0
  - items:
    - id: executor
      agent: plan_executor
      bindings:
      - from_agent_item_id: __CTX__
        from_var: завдання
        to_agent_item_id: executor
        to_var: завдання
      - from_agent_item_id: __CTX__
        from_var: кроки
        to_agent_item_id: executor
        to_var: кроки
      - from_agent_item_id: __CTX__
        from_var: критерії
        to_agent_item_id: executor
        to_var: критерії
      - from_agent_item_id: __CTX__
        from_var: max_reviews
        to_agent_item_id: executor
        to_var: max_reviews
      - from_agent_item_id: __CTX__
        from_var: ollama_host
        to_agent_item_id: executor
        to_var: ollama_host
      - from_agent_item_id: __CTX__
        from_var: model
        to_agent_item_id: executor
        to_var: model
      - from_agent_item_id: __CTX__
        from_var: temperature
        to_agent_item_id: executor
        to_var: temperature
      ui:
        lane_index: 5
        order: 0
  - items:
    - id: execution_map
      agent: execution_result_mapper
      bindings:
      - from_agent_item_id: executor
        from_var: output_json
        to_agent_item_id: execution_map
        to_var: виконання_json
      ui:
        lane_index: 6
        order: 0
  - items:
    - id: cerberus
      agent: cerberus_validator
      bindings:
      - from_agent_item_id: execution_map
        from_var: виконані_кроки
        to_agent_item_id: cerberus
        to_var: виконані_кроки
      - from_agent_item_id: execution_map
        from_var: пройшло_перевірку
        to_agent_item_id: cerberus
        to_var: пройшло_перевірку
      - from_agent_item_id: execution_map
        from_var: коментар_цербера
        to_agent_item_id: cerberus
        to_var: коментар_цербера
      - from_agent_item_id: execution_map
        from_var: потрібно_повторити
        to_agent_item_id: cerberus
        to_var: потрібно_повторити
      ui:
        lane_index: 7
        order: 0
  - items:
    - id: summary
      agent: llm_summary
      bindings:
      - from_agent_item_id: __CTX__
        from_var: завдання
        to_agent_item_id: summary
        to_var: завдання
      - from_agent_item_id: __CTX__
        from_var: виконані_кроки
        to_agent_item_id: summary
        to_var: виконані_кроки
      - from_agent_item_id: __CTX__
        from_var: пройшло_перевірку
        to_agent_item_id: summary
        to_var: пройшло_перевірку
      - from_agent_item_id: __CTX__
        from_var: коментар_цербера
        to_agent_item_id: summary
        to_var: коментар_цербера
      - from_agent_item_id: __CTX__
        from_var: next_stage_hint
        to_agent_item_id: summary
        to_var: next_stage_hint
      - from_agent_item_id: __CTX__
        from_var: ollama_host
        to_agent_item_id: summary
        to_var: ollama_host
      - from_agent_item_id: __CTX__
        from_var: model
        to_agent_item_id: summary
        to_var: model
      - from_agent_item_id: __CTX__
        from_var: temperature
        to_agent_item_id: summary
        to_var: temperature
      - from_agent_item_id: __CTX__
        from_var: summary_require_schema
        to_agent_item_id: summary
        to_var: require_schema
      ui:
        lane_index: 8
        order: 0
  __ctx_bindings:
  - from_agent_item_id: review
    from_var: output_json
    to_agent_item_id: __CTX__
    to_var: аналіз_даних
  - from_agent_item_id: review
    from_var: json_error
    to_agent_item_id: __CTX__
    to_var: json_error
  - from_agent_item_id: review
    from_var: ok
    to_agent_item_id: __CTX__
    to_var: ok
  - from_agent_item_id: review
    from_var: needs_more_info
    to_agent_item_id: __CTX__
    to_var: needs_more_info
  - from_agent_item_id: review
    from_var: clarifications
    to_agent_item_id: __CTX__
    to_var: clarifications
  - from_agent_item_id: review
    from_var: context_summary
    to_agent_item_id: __CTX__
    to_var: context_summary
  - from_agent_item_id: review
    from_var: user_answer
    to_agent_item_id: __CTX__
    to_var: user_answer
  - from_agent_item_id: review
    from_var: clarifications
    to_agent_item_id: __CTX__
    to_var: уточнення
  - from_agent_item_id: planner
    from_var: output_json
    to_agent_item_id: __CTX__
    to_var: план_json
  - from_agent_item_id: planner
    from_var: plan_json_error
    to_agent_item_id: __CTX__
    to_var: план_json_error
  - from_agent_item_id: planner
    from_var: plan_ok
    to_agent_item_id: __CTX__
    to_var: план_ok
  - from_agent_item_id: planner
    from_var: результат
    to_agent_item_id: __CTX__
    to_var: план_як_рядок
  - from_agent_item_id: clarify
    from_var: user_message
    to_agent_item_id: __CTX__
    to_var: відповідь_користувача
  - from_agent_item_id: merge_context
    from_var: попередній_контекст
    to_agent_item_id: __CTX__
    to_var: попередній_контекст
  - from_agent_item_id: normalize
    from_var: результат
    to_agent_item_id: __CTX__
    to_var: нормалізований_план
  - from_agent_item_id: cerberus
    from_var: виконані_кроки
    to_agent_item_id: __CTX__
    to_var: виконані_кроки
  - from_agent_item_id: cerberus
    from_var: пройшло_перевірку
    to_agent_item_id: __CTX__
    to_var: пройшло_перевірку
  - from_agent_item_id: cerberus
    from_var: коментар_цербера
    to_agent_item_id: __CTX__
    to_var: коментар_цербера
  - from_agent_item_id: cerberus
    from_var: потрібно_повторити
    to_agent_item_id: __CTX__
    to_var: потрібно_повторити
  - from_agent_item_id: execution_map
    from_var: результат_виконання
    to_agent_item_id: __CTX__
    to_var: результат_виконання
  - from_agent_item_id: summary
    from_var: результат
    to_agent_item_id: __CTX__
    to_var: фінальна_відповідь
  - from_agent_item_id: summary
    from_var: результат
    to_agent_item_id: __CTX__
    to_var: резюме
  - from_agent_item_id: summary
    from_var: needs_more_info
    to_agent_item_id: __CTX__
    to_var: summary_needs_more_info
  - from_agent_item_id: summary
    from_var: summary_flags
    to_agent_item_id: __CTX__
    to_var: summary_flags
  - from_agent_item_id: summary
    from_var: json_error
    to_agent_item_id: __CTX__
    to_var: summary_json_error
  - from_agent_item_id: normalize
    from_var: результат
    to_agent_item_id: __CTX__
    to_var: план
  - from_agent_item_id: normalize
    from_var: кроки
    to_agent_item_id: __CTX__
    to_var: кроки
  - from_agent_item_id: normalize
    from_var: критерії
    to_agent_item_id: __CTX__
    to_var: критерії
  - from_agent_item_id: normalize
    from_var: next_stage_hint
    to_agent_item_id: __CTX__
    to_var: next_stage_hint
