name: plan_builder_mapper
title_ua: Нормалізація виходу планувальника
description_ua: Приводить кроки, критерії та підказку плану до стандартизованого вигляду
kind: atomic
inputs:
- name: plan_json
- name: json_error_in
  default: ""
- name: stop_agent_execution
  type: bool
  default: false
locals:
- name: code
  value: |
    import json as json_lib

    error = str(json_error_in or "").strip()
    source = plan_json

    if isinstance(source, str):
        try:
            source = json_lib.loads(source)
        except Exception as exc:  # noqa: BLE001
            error = error or f"Invalid JSON: {exc}"
            source = {}

    if not isinstance(source, dict):
        source = {}

    steps_raw = source.get("steps") if isinstance(source, dict) else []
    criteria_raw = source.get("criteria") if isinstance(source, dict) else []
    hint_raw = source.get("next_stage_hint") if isinstance(source, dict) else None

    steps = steps_raw if isinstance(steps_raw, list) else []
    criteria = criteria_raw if isinstance(criteria_raw, list) else []

    steps = [str(step) for step in steps]
    if len(criteria) < len(steps):
        criteria = criteria + ["Прийняти, якщо крок виконано"] * (len(steps) - len(criteria))
    criteria = [str(item) for item in criteria[: len(steps)]]

    next_stage_hint = None
    if hint_raw is not None:
        next_stage_hint = str(hint_raw)

    output_json = {
        "steps": steps,
        "criteria": criteria,
        "next_stage_hint": next_stage_hint,
    }

    ok = bool(steps) and not error
    json_error = error
    кроки = steps
    критерії = criteria
outputs:
- name: output_json
- name: ok
- name: json_error
- name: кроки
- name: критерії
- name: next_stage_hint
executor: python
