name: plan_execution_prompt_builder
title_ua: Побудова промпта для виконання плану
description_ua: Формує промпт для LLM Цербера з завданням, кроками та критеріями
kind: atomic
inputs:
- name: завдання
- name: кроки
- name: критерії
- name: max_reviews
- name: stop_agent_execution
  type: bool
  default: false
locals:
- name: code
  value: |
    текст_завдання = str(завдання)
    steps_list = кроки if isinstance(кроки, list) else []
    criteria_list = критерії if isinstance(критерії, list) else []
    if len(criteria_list) < len(steps_list):
        criteria_list = criteria_list + [""] * (len(steps_list) - len(criteria_list))

    step_lines = []
    for idx, step in enumerate(steps_list):
        criterion = criteria_list[idx] if idx < len(criteria_list) else ""
        step_lines.append(f"- Крок {idx + 1}: {step} | Критерій: {criterion}")
    steps_block = "\n".join(step_lines)
    max_reviews_text = str(max_reviews)

    prompt = f"""
    Ти агент-"Цербер", який виконує та перевіряє план задачі.

    Завдання: {текст_завдання}

    Кроки та критерії:
    {steps_block}

    Максимальна кількість перевірок для одного кроку: {max_reviews_text}.

    Для кожного кроку опиши короткий результат, додай коментар і оцінку відповідності.
    Поверни тільки валідний JSON у форматі:
    {{
      "plan_execution": {{
        "executed_steps": [
          {{"step": "...", "criterion": "...", "result": "...", "comment": "...", "accepted": true, "attempts": 1, "evidence": ["..."]}}
        ],
        "passed": true,
        "needs_retry": false,
        "cerber_comment": "...",
        "summary": "..."
      }}
    }}
    Дотримуйся української мови у текстових полях.
    """

    prompt = prompt.replace('{', '{{').replace('}', '}}')
outputs:
- name: prompt
executor: python
