name: cerberus_validator
title_ua: Перевірка результатів кроків
description_ua: "Жорсткий gate для результатів виконання: вимагає evidence і успішної перевірки"
kind: atomic
executor: python
inputs:
  - name: виконані_кроки
  - name: пройшло_перевірку
  - name: коментар_цербера
  - name: потрібно_повторити
locals:
  - name: code
    value: |
      steps = виконані_кроки or []
      passed = bool(пройшло_перевірку)
      needs_retry = bool(потрібно_повторити)
      comment = коментар_цербера or ""

      if not isinstance(steps, list):
          steps = [steps]

      evidence_missing = False
      for idx, step in enumerate(list(steps)):
          if isinstance(step, dict):
              evidence = step.get("evidence")
              if not isinstance(evidence, list) or len(evidence) == 0:
                  evidence_missing = True
                  updated = {**step, "прийнято": False, "evidence": evidence or []}
                  steps[idx] = updated

      if evidence_missing or len(steps) == 0:
          passed = False
          needs_retry = True
          message = "Докази виконання відсутні або кроки не виконані."
          comment = (comment + " " + message).strip()

      виконані_кроки = steps
      пройшло_перевірку = passed
      коментар_цербера = comment
      потрібно_повторити = needs_retry
outputs:
  - name: виконані_кроки
  - name: пройшло_перевірку
  - name: коментар_цербера
  - name: потрібно_повторити
