name: plan_executor
title_ua: Виконання плану з перевіркою
description_ua: Послідовно виконує кроки плану та моделює перевірку агентом Цербер
kind: atomic
executor: python
inputs:
  - name: завдання
  - name: кроки
  - name: критерії
  - name: max_reviews
locals:
  - name: code
    value: |
      from typing import Any
      def review_step(step: str, criterion: str, attempt: int) -> tuple[bool, str]:
          text = step.lower()
          if 'повтор' in text and attempt == 1:
              return False, 'Цербер просить перевиконати крок'
          if 'даних' in text and 'нема' in text:
              return False, 'Цербер: забагато невідомих'
          return True, 'Цербер прийняв'

      steps: list[str] = list(кроки or []) if isinstance(кроки, (list, tuple)) else []
      crits: list[str] = list(критерії or []) if isinstance(критерії, (list, tuple)) else []
      limit = int(max_reviews or 2)
      results: list[dict[str, Any]] = []
      overall_ok = True
      comments: list[str] = []

      for idx, step in enumerate(steps):
          criterion = crits[idx] if idx < len(crits) else 'Критерій відсутній'
          attempt = 0
          accepted = False
          comment = ''
          while attempt < limit and not accepted:
              attempt += 1
              accepted, comment = review_step(str(step), str(criterion), attempt)
              if not accepted and attempt < limit:
                  comment = f"{comment} (спроба {attempt})"
          if not accepted:
              overall_ok = False
          comments.append(comment)
          results.append(
              {
                  'крок': str(step),
                  'критерій': str(criterion),
                  'спроб': attempt,
                  'прийнято': accepted,
                  'коментар': comment,
                  'результат': f"Результат кроку {idx + 1}: {step}",
              }
          )

      підсумок = "Усі кроки пройшли перевірку" if overall_ok else "Деякі кроки потребують уваги"
      виконані_кроки = results
      пройшло_перевірку = overall_ok
      коментар_цербера = "; ".join(comments)
      потрібно_повторити = not overall_ok
      результат_виконання = підсумок
outputs:
  - name: виконані_кроки
  - name: пройшло_перевірку
  - name: коментар_цербера
  - name: потрібно_повторити
  - name: результат_виконання
